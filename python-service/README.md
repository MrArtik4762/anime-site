# AnidLapi Python –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π Python-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –∞–Ω–∏–º–µ-–≤–∏–¥–µ–æ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, rate limiting –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **FastAPI** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiohttp
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - TTL –∫—ç—à –Ω–∞ 1 —á–∞—Å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Rate Limiting** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- **CORS –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö origins
- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π Fallback –º–µ—Ö–∞–Ω–∏–∑–º** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ AniCLI ‚Üí Aniliberty.top ‚Üí Anilibria (—Å—Ç–∞—Ä—ã–π) –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Prometheus –º–µ—Ç—Ä–∏–∫–∏** - –ø–æ–ª–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—à–∏–±–æ–∫
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- **Docker –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –≥–æ—Ç–æ–≤—ã–π –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

## üìã API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /video`
–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ-–ø–æ—Ç–æ–∫–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–Ω–∏–º–µ –∏ —ç–ø–∏–∑–æ–¥–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `anime_id` (int) - ID –∞–Ω–∏–º–µ
- `episode` (int) - –Ω–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:8000/video?anime_id=123&episode=1"
```

#### `GET /qualities`
–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤ –≤–∏–¥–µ–æ –¥–ª—è —ç–ø–∏–∑–æ–¥–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `anime_id` (int) - ID –∞–Ω–∏–º–µ
- `episode` (int) - –Ω–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:8000/qualities?anime_id=123&episode=1"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "qualities": {
    "fhd": "1080p_url",
    "hd": "720p_url", 
    "sd": "480p_url"
  }
}
```

### –°–ª—É–∂–µ–±–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "cache_size": 42,
  "version": "1.0.0"
}
```

#### `GET /metrics`
–ú–µ—Ç—Ä–∏–∫–∏ Prometheus –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

#### `GET /cache/stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "cache_size": 42,
  "ttl_seconds": 3600,
  "keys": ["video_123_1", "qualities_123_1"]
}
```

#### `DELETE /cache/clear`
–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞.

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
pip install -r requirements.txt
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
```

3. **–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞:**
```bash
python anidLapi_service.py
```

–ò–ª–∏ —Å –ø–æ–º–æ—â—å—é uvicorn:
```bash
uvicorn anidLapi_service:app --host 0.0.0.0 --port 8000 --reload
```

### Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

1. **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞:**
```bash
docker build -t anidlapi-service .
```

2. **–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:**
```bash
docker run -p 8000:8000 -p 8001:8001 anidlapi-service
```

### Docker Compose

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `docker-compose.yml`:

```yaml
services:
  python-service:
    build: ./python-service
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      - FASTAPI_ENV=production
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

–°–µ—Ä–≤–∏—Å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

- `anidlapi_requests_total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `anidlapi_request_duration_seconds` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- `anidlapi_video_requests_total` - –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–µ–æ –ø–æ anime_id
- `anidlapi_errors_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –ø–æ—Ä—Ç—É 8001 –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/metrics`.

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—Ä–æ–≤–Ω—è–º–∏:
- INFO - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ
- WARNING - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, fallback –Ω–∞ Anilibria)
- ERROR - –æ—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `FASTAPI_ENV` | –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã | `development` |
| `HOST` | –•–æ—Å—Ç —Å–µ—Ä–≤–µ—Ä–∞ | `0.0.0.0` |
| `PORT` | –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ | `8000` |
| `WORKERS` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ | `4` |
| `CACHE_TTL` | TTL –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö | `3600` |
| `RATE_LIMIT` | –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ | `100/minute` |
| `METRICS_PORT` | –ü–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ | `8001` |

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TTL –∫—ç—à —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.

–ö—ç—à–∏—Ä—É—é—Ç—Å—è:
- –°—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ (`video_{anime_id}_{episode}`)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—á–µ—Å—Ç–≤–∞—Ö (`qualities_{anime_id}_{episode}`)

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
2. **TTLCache** - —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏
3. **AnilibriaFallback** - —Ä–µ–∑–µ—Ä–≤–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç
4. **Prometheus –º–µ—Ç—Ä–∏–∫–∏** - —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. **Rate Limiter** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
2. –ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ
3. –ó–∞–ø—Ä–æ—Å –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É API (AnimeGo)
4. –ü—Ä–∏ –æ—à–∏–±–∫–µ - fallback –Ω–∞ Anilibria API
5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
6. –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
pytest
```

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º:
```bash
pytest --cov=anidLapi_service
```

## üìù –õ–æ–≥–∏

–õ–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ stdout –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "INFO",
  "message": "Got video URL from AnimeGo for 123:1",
  "anime_id": 123,
  "episode": 1
}
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∏–¥–µ–æ/–∫–∞—á–µ—Å—Ç–≤
- –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limit

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö.

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ó–∞–ø—É—Å–∫ –ø–æ–¥ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Docker
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Rate limiting –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ API
- Streaming –æ—Ç–≤–µ—Ç—ã –¥–ª—è –≤–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Docker –æ–±—Ä–∞–∑—ã

## ü§ù –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- FastAPI 0.103+
- aiohttp –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- anicli-api –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–Ω–∏–º–µ API

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
python-service/
‚îú‚îÄ‚îÄ anidLapi_service.py    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å–µ—Ä–≤–∏—Å–∞
‚îú‚îÄ‚îÄ requirements.txt       # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile            # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .env.example         # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md           # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é anime-site –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ –ª–∏—Ü–µ–Ω–∑–∏—é.