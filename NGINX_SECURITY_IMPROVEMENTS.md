# Улучшения безопасности Nginx

## Обзор

Этот документ описывает улучшения, внесенные в Nginx конфигурацию для повышения безопасности аниме-сайта.

## Основные изменения

### 1. nginx.conf

#### Улучшения:

1. **Оптимизация производительности**
   - Установка `worker_processes auto` для автоматического определения количества процессов
   - Настройка `worker_connections` и `use epoll` для повышения производительности
   - Включение `sendfile`, `tcp_nopush`, `tcp_nodelay` для оптимизации передачи данных

2. **Усиленная безопасность SSL/TLS**
   - Использование современных протоколов TLSv1.2 и TLSv1.3
   - Настройка сильных шифров с предпочтением серверных шифров
   - Отключение SSL session tickets для повышения безопасности
   - Включение OCSP stapling для проверки сертификатов

3. **Дополнительные заголовки безопасности**
   - `Permissions-Policy` для ограничения возможностей браузера
   - Улучшенный `Referrer-Policy`
   - Усиленный `Content-Security-Policy`

4. **Rate limiting**
   - Создание нескольких зон для ограничения разных типов запросов
   - Настройка лимитов для API, входа в систему и общих запросов

5. **Оптимизация сжатия**
   - Улучшенная настройка gzip сжатия
   - Настройка типов сжимаемых данных

### 2. nginx/conf.d/default.conf

#### Улучшения:

1. **Поддержка HTTPS**
   - Разделение HTTP и HTTPS конфигураций
   - Добавление перенаправления с HTTP на HTTPS (для продакшена)
   - Полная настройка SSL/TLS для HTTPS

2. **Усиленные заголовки безопасности**
   - `Strict-Transport-Security` (HSTS) с max-age 1 год
   - `Permissions-Policy` для ограничения API браузера
   - Улучшенные настройки CSP

3. **Улучшенный rate limiting**
   - Разные лимиты для разных типов эндпоинтов
   - Настройка burst для обработки пиковых нагрузок

4. **Защита от атак**
   - Защита от атак типа Slowloris
   - Ограничение количества одновременных соединений
   - Настройка таймаутов для защиты от DoS атак

5. **Оптимизация потоковой передачи**
   - Настройка буферизации для HLS потоков
   - Ограничение скорости для потоковой передачи
   - Оптимизация для больших файлов

6. **Улучшенная CORS настройка**
   - Детальные заголовки CORS для потоковой передачи
   - Разрешение конкретных методов и заголовков

## Безопасные практики

### 1. SSL/TLS безопасность

- **Проблема:** Устаревшие протоколы и слабые шифры могут привести к уязвимостям.
- **Решение:** Использование современных протоколов TLS и сильных шифров.

### 2. Заголовки безопасности

- **Проблема:** Отсутствие или неправильные заголовки безопасности могут привести к XSS, Clickjacking и другим атакам.
- **Решение:** Внедрение полного набора заголовков безопасности.

### 3. Rate limiting

- **Проблема:** Отсутствие ограничения запросов может привести к DoS атакам и brute force атакам.
- **Решение:** Настройка лимитов для разных типов запросов.

### 4. HSTS

- **Проблема:** Отсутствие HSTS может привести к атакам типа downgrade.
- **Решение:** Включение HSTS с preload опцией.

### 5. Защита от DoS атак

- **Проблема:** Уязвимость к DoS атакам может привести к недоступности сервиса.
- **Решение:** Настройка таймаутов, ограничение соединений и буферов.

### 6. CORS безопасность

- **Проблема:** Неправильная настройка CORS может привести к утечке данных.
- **Решение:** Детальная настройка CORS с ограничением методов и заголовков.

## Дальнейшие улучшения

### 1. Веб-приложение брандмауэр (WAF)

Настройка модуля `modsecurity` для Nginx:

```nginx
# Пример настройки WAF
modsecurity on;
modsecurity_rules_file /etc/nginx/modsecurity.conf;
```

### 2. Обратный прокси с аутентификацией

Добавление базовой аутентификации для административных эндпоинтов:

```nginx
location /admin {
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

### 3. Ограничение методов HTTP

Ограничение разрешенных HTTP методов:

```nginx
if ($request_method !~ ^(GET|HEAD|POST)$ ) {
    return 405;
}
```

### 4. Защита от ботов

Настройка Captcha или ограничение для ботов:

```nginx
# Блокировка известных ботов
if ($http_user_agent ~* (bot|crawler|spider|scraper)) {
    return 403;
}
```

### 5. Изоляция контента

Использование Content Security Policy изолировать контент:

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'";
```

### 6. Мониторинг и логирование

Улучшенное логирование и мониторинг:

```nginx
# Детальное логирование
log_format security '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   'rt=$request_time uct="$upstream_connect_time" '
                   'uht="$upstream_header_time" urt="$upstream_response_time"';

access_log /var/log/nginx/security.log security;
```

## Заключение

Внесенные улучшения значительно повышают безопасность Nginx конфигурации аниме-сайта. Основные меры включают усиленную настройку SSL/TLS, внедрение полного набора заголовков безопасности, настройку rate limiting и защиту от DoS атак.

Рекомендуется продолжать работу над улучшением безопасности, внедряя дополнительные меры, такие как WAF, обратный прокси с аутентификацией и улучшенное мониторинг.