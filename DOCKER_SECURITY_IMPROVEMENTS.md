# Улучшения безопасности Docker

## Обзор

Этот документ описывает улучшения, внесенные в Docker конфигурацию для повышения безопасности аниме-сайта.

## Изменения в Dockerfile

### 1. Клиент (client/Dockerfile)

#### Улучшения:

1. **Использование конкретных версий образов**
   - Заменен `node:18-alpine` на `node:18.18.0-alpine3.18`
   - Заменен `nginx:alpine` на `nginx:1.25.3-alpine3.18`

2. **Установка переменных окружения для безопасности**
   - Добавлены переменные для контроля npm
   - Установлена временная зона UTC

3. **Установка зависимостей с повышенной безопасностью**
   - Добавлены флаги `--no-audit`, `--no-fund`, `--ignore-scripts`
   - Отключен аудит и сбор данных

4. **Установка необходимых инструментов с пониженными привилегиями**
   - Установлены только необходимые пакеты
   - После использования пакеты удаляются

5. **Создание пользователя с пониженными привилегиями**
   - Пользователь `nextjs` с ограниченными правами
   - Отключен вход в систему (`/sbin/nologin`)

6. **Правильные настройки разрешений**
   - Все файлы и директории принадлежат пользователю `nextjs`
   - Правильно установлены права доступа

7. **Улучшенный health check**
   - Настройки для проверки состояния приложения

### 2. Сервер (server/Dockerfile)

#### Улучшения:

1. **Использование конкретных версий образов**
   - Заменен `node:18-alpine` на `node:18.18.0-alpine3.18`

2. **Установка переменных окружения для безопасности**
   - Добавлены переменные для контроля окружения
   - Установлена временная зона UTC

3. **Установка зависимостей с повышенной безопасностью**
   - Добавлены флаги `--no-audit`, `--no-fund`, `--ignore-scripts`

4. **Создание пользователя с пониженными привилегиями**
   - Пользователь `appuser` с ограниченными правами
   - Отключен вход в систему (`/sbin/nologin`)

5. **Правильные настройки разрешений**
   - Установлены строгие права доступа к файлам
   - Удалены ненужные файлы и директории

6. **Улучшенный health check**
   - Добавлен заголовок User-Agent для проверки

7. **Улучшенный запуск приложения**
   - Добавлены флаги для контроля памяти и предупреждений

## Изменения в docker-compose.yml

### 1. PostgreSQL

#### Улучшения:

1. **Использование конкретной версии**
   - Заменен `postgres:15-alpine` на `postgres:15.5-alpine3.18`

2. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти
   - Добавлены резервирования ресурсов

### 2. Redis

#### Улучшения:

1. **Использование конкретной версии**
   - Заменен `redis:7-alpine` на `redis:7.2.3-alpine3.18`

2. **Парольная защита**
   - Добавлен пароль для доступа к Redis
   - Использование переменной окружения

3. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти

### 3. Клиент (Frontend)

#### Улучшения:

1. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти

### 4. Сервер (Backend)

#### Улучшения:

1. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти
   - Выделено больше ресурсов для сервера

### 5. Nginx

#### Улучшения:

1. **Использование конкретной версии**
   - Заменен `nginx:alpine` на `nginx:1.25.3-alpine3.18`

2. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти

### 6. HLS Media Server

#### Улучшения:

1. **Использование конкретной версии**
   - Заменен `ant-media-server/ant-media-server-ce:latest` на `ant-media-server/ant-media-server-ce:2.5.1`

2. **Ограничение ресурсов**
   - Установлены лимиты процессора и памяти

## Безопасные практики

### 1. Использование конкретных версий образов

- **Проблема:** Использование тега `:latest` может привести к неожиданным обновлениям и уязвимостям.
- **Решение:** Использование конкретных версий образов обеспечивает воспроизводимость и контроль над уязвимостями.

### 2. Создание непривилегированных пользователей

- **Проблема:** Запуск контейнеров от root пользователя повышает риск эскалации привилегий.
- **Решение:** Создание непривилегированных пользователей с минимально необходимыми правами.

### 3. Ограничение ресурсов

- **Проблема:** Неограниченное использование ресурсов может привести к DoS атакам.
- **Решение:** Установка лимитов на использование CPU и памяти для каждого сервиса.

### 4. Безопасная конфигурация окружения

- **Проблема:** Небезопасные переменные окружения могут привести к утечке данных.
- **Решение:** Использование переменных окружения для конфиденциальных данных и паролей.

### 5. Правильные настройки разрешений

- **Проблема:** Неправильные настройки разрешений могут привести к несанкционированному доступу.
- **Решение:** Установка правильных прав доступа к файлам и директориям.

### 6. Health checks

- **Проблема:** Отсутствие проверки состояния сервиса может привести к работе неработающих контейнеров.
- **Решение:** Настройка health checks для автоматической перезагрузки неработающих сервисов.

## Дальнейшие улучшения

### 1. Использование Docker secrets

Для хранения конфиденциальных данных можно использовать Docker secrets:

```yaml
secrets:
  - db_password
  - redis_password

services:
  postgres:
    secrets:
      - db_password
```

### 2. Настройка сетевой безопасности

Использование сетевых политик для ограничения взаимодействия между сервисами:

```yaml
networks:
  frontend:
    internal: true
  backend:
    internal: true
```

### 3. Включение Docker Content Trust

Для верификации образов:

```bash
export DOCKER_CONTENT_TRUST=1
```

### 4. Регулярное обновление образов

Создание процесса регулярного обновления образов для устранения уязвимостей.

### 5. Использование сканеров уязвимостей

Интеграция сканеров уязвимостей в CI/CD процесс:

- Trivy
- Clair
- Docker Bench for Security

## Заключение

Внесенные улучшения значительно повышают безопасность Docker-контейнеров аниме-сайта. Основные меры включают использование конкретных версий образов, создание непривилегированных пользователей, ограничение ресурсов и правильную настройку разрешений.

Рекомендуется продолжать работу над улучшением безопасности, внедряя дополнительные меры, такие как использование Docker secrets, настройка сетевой безопасности и регулярное сканирование уязвимостей.