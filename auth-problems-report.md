# Отчет о проблемах с входом в аккаунт

## Обнаруженные проблемы

### 1. Несоответствие требований к паролю между клиентом и сервером

**Проблема:**
- Клиент (LoginPage.js): требует минимум 6 символов
- Сервер (authController.js): требует минимум 12 символов с шаблоном `/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{12,}/`

**Решение:**
- Синхронизировать требования к паролю на клиенте и сервере
- Обновить валидацию на клиенте до требований сервера

### 2. Конфликт между Mongoose и Knex моделями

**Проблема:**
- Код использует Mongoose методы (`findByIdAndUpdate`, `$gt` оператор)
- База данных настроена на Knex
- Модель `UserKnex.js` существует, но используется `User.js` (Mongoose модель)

**Решение:**
- Использовать только Knex модель (`UserKnex.js`)
- Заменить Mongoose методы на Knex аналоги
- Удалить или закомментировать Mongoose модель

### 3. Отсутствие JWT секретов

**Проблема:**
- Переменные окружения `JWT_SECRET` и `JWT_REFRESH_SECRET` были пустыми
- Это приводит к ошибкам при генерации и верификации токенов

**Решение:**
- Установить безопасные JWT секреты в файле `.env`

### 4. Проблемы с запуском сервера

**Проблема:**
- Сервал падает при запуске без вывода ошибок
- Порт 5000 уже занят

**Решение:**
- Использовать другой порт (3001)
- Добавить обработку ошибок и логирование

## Инструкции по исправлению

### 1. Установка JWT секретов

Добавьте в файл `server/.env`:

```
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-this-in-production
```

### 2. Синхронизация требований к паролю

В файле `client/src/pages/LoginPage.js` обновите валидацию пароля:

```javascript
// Было
if (password.length < 6) {
  // ...
}

// Стало
if (password.length < 12) {
  // ...
}
```

### 3. Использование только Knex модели

В файле `server/controllers/authController.js`:

1. Убедитесь, что используется правильная модель:
```javascript
const User = require('../models/UserKnex');
```

2. Замените Mongoose методы на Knex аналоги:
```javascript
// Было
await User.findByIdAndUpdate(userId, { ... });

// Стало
await User.findByIdAndUpdate(userId, { ... });
```

3. Удалите использование Mongoose операторов:
```javascript
// Было
{ $gt: new Date() }

// Стало
new Date(Date.now() - 1)
```

### 4. Проверка конфигурации

Убедитесь, что в файле `server/.env` правильно настроена база данных:

```
# SQLite Configuration (для разработки и тестов)
DB_CLIENT=sqlite3
DB_FILENAME=./dev.sqlite3
```

## Тестирование

Для тестирования аутентификации можно использовать тестовый сервер:

```bash
cd server
node test-auth.js
```

Доступные эндпоинты:
- Регистрация: `POST http://localhost:3001/api/auth/register`
- Вход: `POST http://localhost:3001/api/auth/login`
- Проверка токена: `GET http://localhost:3001/api/auth/me`

## Рекомендации

1. **Безопасность**: Используйте сложные JWT секреты в продакшене
2. **Логирование**: Добавьте подробное логирование для отладки аутентификации
3. **Тестирование**: Напишите интеграционные тесты для аутентификации
4. **Валидация**: Используйте централизованную валидацию для всех входных данных
5. **Обработка ошибок**: Улучшите обработку и отображение ошибок аутентификации

## Заключение

Основные проблемы с входом в аккаунт вызваны несоответствием между клиентской и серверной частями, а также неправильным использованием ORM. После исправления этих проблем аутентификация должна работать корректно.