name: Auto Update README

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC (5:00 –ø–æ –úinsk)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–º–º–∏—Ç–æ–≤
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        cd scripts && npm ci
    
    - name: Update README.md
      run: |
        node scripts/update-readme.js
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if README was updated
      id: check-readme
      run: |
        if git diff --quiet HEAD -- README.md; then
          echo "readme-updated=false" >> $GITHUB_OUTPUT
          echo "README.md –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        else
          echo "readme-updated=true" >> $GITHUB_OUTPUT
          echo "README.md –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
        fi
    
    - name: Commit and push README changes
      if: steps.check-readme.outputs.readme-updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "docs: auto-update README.md [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Pull Request for README updates
      if: github.event_name == 'schedule' && steps.check-readme.outputs.readme-updated == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: auto-update README.md [skip ci]"
        title: "üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.md"
        body: |
          ## üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.md
          
          –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.md, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.
          
          ### –ß—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:
          - –†–∞–∑–¥–µ–ª "–ù–µ–¥–∞–≤–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
          - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
          - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–∞—Ö
          - –î–∞—Ç—ã –∏ –≤–µ—Ä—Å–∏–∏
          
          ### ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ–º:
          `update-readme.yml`
          
          ---
          *–≠—Ç–æ PR –±—ã–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º.*
        branch: "auto-update-readme"
        branch-suffix: "timestamp"
        delete-branch: true

  update-changelog:
    runs-on: ubuntu-latest
    needs: update-readme
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        cd scripts && npm ci
    
    - name: Prepare commit
      run: |
        node scripts/prepare-commit.js update
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if CHANGELOG was updated
      id: check-changelog
      run: |
        if [ -f CHANGELOG.md ]; then
          if git diff --quiet HEAD -- CHANGELOG.md; then
            echo "changelog-updated=false" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
          else
            echo "changelog-updated=true" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
          fi
        else
          echo "changelog-updated=false" >> $GITHUB_OUTPUT
          echo "CHANGELOG.md –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi
    
    - name: Commit and push CHANGELOG changes
      if: steps.check-changelog.outputs.changelog-updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CHANGELOG.md
        git diff --staged --quiet || git commit -m "docs: auto-update CHANGELOG.md [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [update-readme, update-changelog]
    if: always()
    
    steps:
    - name: Notify status
      run: |
        if [[ "${{ needs.update-readme.result }}" == "success" && "${{ needs.update-changelog.result }}" == "success" ]]; then
          echo "‚úÖ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
        else
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
          exit 1
        fi