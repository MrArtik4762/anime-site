name: Notifications

on:
  issues:
    types: [opened, edited, labeled, unlabeled, closed, reopened, assigned, unassigned]
  pull_request:
    types: [opened, edited, synchronize, reopened, closed, labeled, unlabeled, assigned, unassigned]
  push:
    branches: [ main, develop, staging ]
  workflow_run:
    workflows: [ "CI/CD Pipeline", "Dependency Updates" ]
    types: [completed, requested]

jobs:
  send-notifications:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send issue notification
        if: github.event_name == 'issues'
        run: |
          echo "ğŸ“ Issue Event: ${{ github.event.action }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue URL: ${{ github.event.issue.html_url }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ Author: ${{ github.event.issue.user.login }}"
          echo "ğŸ“… Date: $(date -u)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Send pull request notification
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ”„ Pull Request Event: ${{ github.event.action }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ“… Date: $(date -u)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Send push notification
        if: github.event_name == 'push'
        run: |
          echo "ğŸš€ Push Event"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“… Date: $(date -u)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Send workflow run notification
        if: github.event_name == 'workflow_run'
        run: |
          echo "ğŸƒ Workflow Run Event: ${{ github.event.action }}"
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Status: ${{ github.event.workflow_run.conclusion }}"
          echo "URL: ${{ github.event.workflow_run.html_url }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
          echo "ğŸ“… Date: $(date -u)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Send Slack notification
        if: (success() || failure()) && (github.event_name == 'issues' || github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_run')
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_MESSAGE: 'GitHub Event: ${{ github.event_name }} - Status: ${{ job.status }}'
          SLACK_TITLE: 'Anime Site GitHub Activity'
          SLACK_USERNAME: 'GitHub Bot'
          SLACK_ICON_EMOJI: ':github:'
          SLACK_FOOTER: 'Anime Site Project'
          SLACK_FIELDS: 'repo,commit,author,action,eventName,ref,workflow'
          MSG_MINIMAL: 'false'

      - name: Log GitHub activity
        if: (success() || failure()) && (github.event_name == 'issues' || github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_run')
        run: |
          echo "ğŸ”„ GitHub Activity Event: ${{ github.event_name }}"
          echo "ğŸ“Š Status: ${{ job.status }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“… Date: $(date -u)"

  deployment-notifications:
    name: Deployment Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.name == 'CI/CD Pipeline' && github.event.action == 'completed'
    steps:
      - name: Send deployment notification
        run: |
          echo "ğŸš€ Deployment Notification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Extract deployment information from workflow run
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ‰ Environment: ${{ github.event.workflow_run.event }}"
            echo "ğŸ”— Repository: ${{ github.repository }}"
            echo "ğŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
            echo "ğŸ“… Date: $(date -u)"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ’¥ Environment: ${{ github.event.workflow_run.event }}"
            echo "ğŸ”— Repository: ${{ github.repository }}"
            echo "ğŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
            echo "ğŸ“… Date: $(date -u)"
          fi

      - name: Send deployment Slack notification
        if: success() || failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ github.event.workflow_run.conclusion == 'success' && 'good' || 'danger' }}
          SLACK_MESSAGE: 'Deployment ${{ github.event.workflow_run.conclusion }} for ${{ github.event.workflow_run.event }} environment'
          SLACK_TITLE: 'Deployment Status'
          SLACK_USERNAME: 'Deployment Bot'
          SLACK_ICON_EMOJI: ':rocket:'
          SLACK_FOOTER: 'Anime Site Project'
          SLACK_FIELDS: 'repo,commit,author,action,eventName,ref,workflow'
          MSG_MINIMAL: 'false'

      - name: Log deployment status
        if: success() || failure()
        run: |
          echo "ğŸš€ Deployment Status: ${{ github.event.workflow_run.conclusion }}"
          echo "ğŸ‰ Environment: ${{ github.event.workflow_run.event }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
          echo "ğŸ“… Date: $(date -u)"